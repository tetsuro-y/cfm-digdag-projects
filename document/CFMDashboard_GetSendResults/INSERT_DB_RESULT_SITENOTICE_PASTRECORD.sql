BEGIN
;

CREATE TEMP TABLE TAT_DB_RESULT_SITENOTICE_TMP_TERM AS
SELECT
    '20151101' AS TT_STARTDT
    ,'20180331' AS TT_ENDDT
;

/*
    配信実績更新
 */
-- 更新データを初期化
DELETE FROM TAT_DB_RESULT_SITENOTICE
WHERE
    RSN_SENDDT >= (SELECT TT_STARTDT::TIMESTAMP FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND RSN_SENDDT < (SELECT TT_ENDDT::TIMESTAMP FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND RSN_SENDDT IS NOT NULL
;

-- サイトお知らせ（WEB）データ登録
INSERT INTO TAT_DB_RESULT_SITENOTICE (
    RSN_CAMPAIGNID
    ,RSN_CHANNELID
    ,RSN_SENDDT
    ,RSN_CNT_SEND
)
SELECT
     PNDCAMPAIGNID AS CAMPAIGNID
    ,4 AS CHANNELID
    ,DATE_TRUNC('DAY', PNDCONTACTDT) AS SENDDT
    ,COUNT(1) AS CNT_SEND
FROM
    TPNNOTICEDELIVERY
WHERE
    PNDCONTACTDT >= (SELECT TT_STARTDT::TIMESTAMP FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND PNDCONTACTDT < (SELECT TT_ENDDT::TIMESTAMP FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
GROUP BY
    CAMPAIGNID
    ,SENDDT
;

-- サイトお知らせ（アプリ）データ登録
INSERT INTO TAT_DB_RESULT_SITENOTICE (
    RSN_CAMPAIGNID
    ,RSN_CHANNELID
    ,RSN_SENDDT
    ,RSN_CNT_SEND
)
SELECT
     PNDCAMPAIGNID AS CAMPAIGNID
    ,5 AS CHANNELID
    ,DATE_TRUNC('DAY', PNDCONTACTDT) AS SENDDT
    ,COUNT(1) AS CNT_SEND
FROM
    TPNNOTICEDELIVERY
WHERE
    PNDCONTACTDT >= (SELECT TT_STARTDT::TIMESTAMP FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND PNDCONTACTDT < (SELECT TT_ENDDT::TIMESTAMP FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
GROUP BY
    CAMPAIGNID
    ,SENDDT
;

/*
    流入実績更新
 */
-- 更新データを初期化
DELETE FROM TAT_DB_RESULT_SITENOTICE
WHERE
    RSN_VISITDT >= (SELECT TT_STARTDT::TIMESTAMP FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND RSN_VISITDT < (SELECT TT_ENDDT::TIMESTAMP FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND RSN_SENDDT IS NULL
;

-- サイトお知らせ（WEB、アプリ）データ登録
INSERT INTO TAT_DB_RESULT_SITENOTICE (
    RSN_CAMPAIGNID
    ,RSN_CHANNELID
    ,RSN_VISITDT
    ,RSN_CNT_CLICK
    ,RSN_REVENUE_TOTAL
)
SELECT
     HVU_CAMPAIGNID AS CAMPAIGNID
    ,HVU_CHANNELID AS CHANNELID
    ,DATE_TRUNC('DAY', HVU_VISITTIME) AS CLICKDT
    ,COUNT(DISTINCT HVU_FULLVISITORID) AS CNT_CLICK
    ,NVL(SUM(HVU_REVENUE), 0) AS REVENUE_TOTAL
FROM
    TAT_DB_HISTORY_VISIT_USER
WHERE
    HVU_VISITTIME >= (SELECT TT_STARTDT::TIMESTAMP FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND HVU_VISITTIME < (SELECT TT_ENDDT::TIMESTAMP FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND HVU_CHANNELID IN (4, 5)
GROUP BY
    CAMPAIGNID
    ,CHANNELID
    ,CLICKDT
;


COMMIT
;