BEGIN
;

CREATE TEMP TABLE TAT_DB_RESULT_SITENOTICE_TMP_TERM AS
SELECT
    DATE_TRUNC('MONTH', CURRENT_DATE + INTERVAL '-25MONTHS') AS TT_STARTDT
    ,CURRENT_DATE AS TT_ENDDT
;

/*
    配信実績更新
 */
-- 更新データを初期化
DELETE FROM TAT_DB_RESULT_SITENOTICE
WHERE
    RSN_SENDDT >= (SELECT TT_STARTDT FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND RSN_SENDDT < (SELECT TT_ENDDT FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND RSN_SENDDT IS NOT NULL
;

-- 配信実績集計
CREATE TEMP TABLE TAT_DB_RESULT_SITENOTICE_TMP_SEND (
    SENDDT DATE
    ,CAMPAIGNID INTEGER
    ,CNT_SEND BIGINT
)
DISTRIBUTE ON (SENDDT, CAMPAIGNID);

INSERT INTO TAT_DB_RESULT_SITENOTICE_TMP_SEND (
    SENDDT
    ,CAMPAIGNID
    ,CNT_SEND
)
SELECT
    DATE_TRUNC('DAY', PNDCONTACTDT) AS SENDDT
    ,PNDCAMPAIGNID AS CAMPAIGNID
    ,COUNT(1) AS CNT_SEND
FROM
    TPNNOTICEDELIVERY
WHERE
    PNDCONTACTDT >= (SELECT TT_STARTDT FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND PNDCONTACTDT < (SELECT TT_ENDDT FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
GROUP BY
    SENDDT
    ,CAMPAIGNID

UNION ALL

SELECT
    DATE_TRUNC('DAY', PNDUCONTACTDT) AS SENDDT
    ,PNDUCAMPAIGNID AS CAMPAIGNID
    ,COUNT(1) AS CNT_SEND
FROM
    TPNNOTICEDELIVERYUID
WHERE
    PNDUCONTACTDT >= (SELECT TT_STARTDT FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND PNDUCONTACTDT < (SELECT TT_ENDDT FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
GROUP BY
    SENDDT
    ,CAMPAIGNID
;

-- サイトお知らせ（WEB）データ登録
INSERT INTO TAT_DB_RESULT_SITENOTICE (
    RSN_CAMPAIGNID
    ,RSN_CHANNELID
    ,RSN_SENDDT
    ,RSN_CNT_SEND
)
SELECT
     CAMPAIGNID
    ,4 AS CHANNELID
    ,SENDDT
    ,CNT_SEND
FROM
    TAT_DB_RESULT_SITENOTICE_TMP_SEND
    INNER JOIN (
        SELECT
            MPM_MAPPINGID AS CP_CAMPAIGNID
        FROM
            TAT_DB_MASTER_PARAMETER_MAPPING
        WHERE
            MPM_CHANNELID = 4
        GROUP BY
            MPM_MAPPINGID
    ) CPMST /*PREFIX = CP*/ ON CAMPAIGNID = CP_CAMPAIGNID
;

-- サイトお知らせ（アプリ）データ登録
INSERT INTO TAT_DB_RESULT_SITENOTICE (
    RSN_CAMPAIGNID
    ,RSN_CHANNELID
    ,RSN_SENDDT
    ,RSN_CNT_SEND
)
SELECT
    CAMPAIGNID
    ,5 AS CHANNELID
    ,SENDDT
    ,CNT_SEND
FROM
    TAT_DB_RESULT_SITENOTICE_TMP_SEND
    INNER JOIN (
        SELECT
            MPM_MAPPINGID AS CP_CAMPAIGNID
        FROM
            TAT_DB_MASTER_PARAMETER_MAPPING
        WHERE
            MPM_CHANNELID = 5
        GROUP BY
            MPM_MAPPINGID
    ) CPMST /*PREFIX = CP*/ ON CAMPAIGNID = CP_CAMPAIGNID
;

/*
    流入実績更新
 */
-- 更新データを初期化
DELETE FROM TAT_DB_RESULT_SITENOTICE
WHERE
    RSN_VISITDT >= (SELECT TT_STARTDT FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND RSN_VISITDT < (SELECT TT_ENDDT FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
AND RSN_VISITDT IS NOT NULL
;

-- サイトお知らせ（WEB、アプリ）データ登録
INSERT INTO TAT_DB_RESULT_SITENOTICE (
    RSN_CAMPAIGNID
    ,RSN_CHANNELID
    ,RSN_VISITDT
    ,RSN_CNT_CLICK_ALL
    ,RSN_CNT_CLICK_IOS
    ,RSN_CNT_CLICK_ANDROID
    ,RSN_CNT_CV_ALL
    ,RSN_CNT_CV_IOS
    ,RSN_CNT_CV_ANDROID
    ,RSN_REVENUE_TOTAL_ALL
    ,RSN_REVENUE_TOTAL_IOS
    ,RSN_REVENUE_TOTAL_ANDROID
)
SELECT
    CAMPAIGNID
    ,CHANNELID
    ,CLICKDT
    ,SUM(CNT_CLICK) AS CNT_CLICK_ALL
    ,NVL(SUM(CASE OSID WHEN 1 THEN CNT_CLICK END), 0) AS CNT_CLICK_IOS
    ,NVL(SUM(CASE OSID WHEN 2 THEN CNT_CLICK END), 0) AS CNT_CLICK_ANDROID
    ,SUM(CNT_CV) AS CNT_CV_ALL
    ,NVL(SUM(CASE OSID WHEN 1 THEN CNT_CV END), 0) AS CNT_CV_IOS
    ,NVL(SUM(CASE OSID WHEN 2 THEN CNT_CV END), 0) AS CNT_CV_ANDROID
    ,NVL(SUM(REVENUE_TOTAL), 0) AS REVENUE_TOTAL_ALL
    ,NVL(SUM(CASE OSID WHEN 1 THEN REVENUE_TOTAL END), 0) AS REVENUE_TOTAL_IOS
    ,NVL(SUM(CASE OSID WHEN 2 THEN REVENUE_TOTAL END), 0) AS REVENUE_TOTAL_ANDROID
FROM
    (
        SELECT
             HVU_CAMPAIGNID AS CAMPAIGNID
            ,HVU_CHANNELID AS CHANNELID
            ,HVU_OSID AS OSID
            ,DATE_TRUNC('DAY', HVU_VISITTIME) AS CLICKDT
            ,COUNT(DISTINCT HVU_FULLVISITORID) AS CNT_CLICK
            ,COUNT(DISTINCT HVU_FULLVISITORID_CV) AS CNT_CV
            ,SUM(HVU_REVENUE) AS REVENUE_TOTAL
        FROM
            TAT_DB_HISTORY_VISIT_USER
        WHERE
            HVU_VISITTIME >= (SELECT TT_STARTDT FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
        AND HVU_VISITTIME < (SELECT TT_ENDDT FROM TAT_DB_RESULT_SITENOTICE_TMP_TERM)
        AND HVU_CHANNELID IN (4, 5)
        GROUP BY
            CAMPAIGNID
            ,CHANNELID
            ,OSID
            ,CLICKDT
    ) BASE
WHERE
    CLICKDT IS NOT NULL
GROUP BY
    CAMPAIGNID
    ,CHANNELID
    ,CLICKDT
;

COMMIT
;