BEGIN
;

CREATE TABLE TAT_DB_RESULT_MASSLINE
(
    RML_CHANNEL_DETAILID BYTEINT NOT NULL,
    RML_CAMPAIGNID INTEGER NOT NULL,
    RML_SENDDT DATE,
    RML_VISITDT DATE,
    RML_CNT_CLICK INTEGER NOT NULL,
    RML_REVENUE_TOTAL BIGINT NOT NULL
)
DISTRIBUTE ON (RML_CHANNEL_DETAILID, RML_CAMPAIGNID, RML_SENDDT, RML_VISITDT)
;

--日ごとの流入通数、経由売上
INSERT INTO TAT_DB_RESULT_MASSLINE
SELECT
    HVU_CHANNEL_DETAILID AS RML_CHANNEL_DETAILID
    ,HVU_CAMPAIGNID AS RML_CAMPAIGNID
    ,HVU_SENDDT AS RML_SENDDT
    ,NULL AS RML_VISITDT
    ,COUNT(HVU_FULLVISITORID) AS RML_CNT_CLICK
    ,SUM(HVU_REVENUE) AS RML_REVENUE_TOTAL
FROM
    TAT_DB_HISTORY_VISIT_USER
WHERE
    HVU_SENDDT >= '${pd_base_date}'::DATE + INTERVAL '-8DAYS'
    AND HVU_CHANNELID = 2--LINE
    AND HVU_CHANNEL_DETAILID IN (2,5)--マス,タイムライン
GROUP BY
    RML_CHANNEL_DETAILID
    ,RML_CAMPAIGNID
    ,RML_SENDDT
    ,RML_VISITDT

UNION ALL

SELECT
    HVU_CHANNEL_DETAILID AS RML_CHANNEL_DETAILID
    ,HVU_CAMPAIGNID AS RML_CAMPAIGNID
    ,NULL AS RML_SENDDT
    ,TO_CHAR(HVU_VISITTIME,'YYYY-MM-DD') AS RML_VISITDT
    ,COUNT(HVU_FULLVISITORID) AS RML_CNT_CLICK
    ,SUM(HVU_REVENUE) AS RML_REVENUE_TOTAL
FROM
    TAT_DB_HISTORY_VISIT_USER
WHERE
    HVU_VISITTIME >= '${pd_base_date}'::DATE + INTERVAL '-8DAYS'
    AND HVU_CHANNELID = 2--LINE
    AND HVU_CHANNEL_DETAILID = 6--リッチメニュー
GROUP BY
    RML_CHANNEL_DETAILID
    ,RML_CAMPAIGNID
    ,RML_SENDDT
    ,RML_VISITDT

COMMIT
;