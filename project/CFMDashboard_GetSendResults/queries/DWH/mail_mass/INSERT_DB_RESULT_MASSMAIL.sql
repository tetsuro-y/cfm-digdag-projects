----------------------------------
--集計対象のキャンペーンIDと配信日
----------------------------------
CREATE TEMP TABLE TEMP_MASSMAIL_PARAMETER
(
	MASSMAIL_CAMPAIGNID INTEGER
	,MASSMAIL_SENDDT DATE
	,MASSMAIL_CHANNELID BYTEINT
	,MASSMAIL_DETAILID BYTEINT
)
;
INSERT INTO TEMP_MASSMAIL_PARAMETER
SELECT DISTINCT
	MPM_MAPPINGID AS MASSMAIL_CAMPAIGNID
	,HVU_SENDDT AS MASSMAIL_SENDDT
	,HVU_CHANNELID AS MASSMAIL_CHANNELID
	,HVU_CHANNEL_DETAILID AS MASSMAIL_DETAILID
FROM
	TAT_DB_MASTER_PARAMETER_MAPPING
	INNER JOIN TAT_DB_HISTORY_VISIT_USER ON MPM_MAPPINGID = HVU_CAMPAIGNID
WHERE
	MPM_CHANNELID = 1--メール
	AND MPM_CHANNEL_DETAILID = 2--マス
	AND HVU_CHANNELID = 1
	AND HVU_CHANNEL_DETAILID = 2
	AND HVU_SENDDT >= CAST('${pd_base_date}' AS TIMESTAMP) + INTERVAL '-8DAYS'
	AND HVU_SENDDT < CAST('${pd_base_date}' AS TIMESTAMP)
;

-------------------------------
--マスメールの集計結果をINSERT
-------------------------------

--※配信数・開封数はTUCEMAILDELIVERYとCAMPAIGNIDとJOINできないため仮の値

INSERT INTO TAT_DB_RESULT_MASSMAIL
SELECT
	MASSMAIL_CAMPAIGNID
	,MASSMAIL_SENDDT
	,50000 AS CNT_SEND_TOTAL
	,30000 AS CNT_SEND_PC
	,20000 AS CNT_SEND_MO
	,5000 AS CNT_OPEN
	,ROUND(CAST(CNT_OPEN AS NUMERIC) / CAST(CNT_SEND_TOTAL AS NUMERIC), 2) AS CNT_OPEN_PER
	,CNT_CLICK_TOTAL
	,CNT_CLICK_PC
	,CNT_CLICK_MO
	,ROUND(CAST(CNT_CLICK_PC AS NUMERIC) / CAST(CNT_OPEN AS NUMERIC), 2) AS OPEN_CLICK_PER_PC
	,ROUND(CAST(CNT_CLICK_MO AS NUMERIC) / CAST(CNT_SEND_MO AS NUMERIC), 2) AS SEND_CLICK_PER_MO
	,REVENUE_TOTAL
	,REVENUE_PC
	,REVENUE_MO
FROM
	TEMP_MASSMAIL_PARAMETER
	LEFT JOIN (
		----------------
		--配信数・開封数
		----------------
		SELECT
			MASSMAIL_CAMPAIGNID AS CAMPAIGN_SEND
			,DATE_TRUNC('DAY', DELIVERYDT) AS SENDDT_SEND
			,HVU_CHANNELID AS CHANNELID_SEND
			,HVU_CHANNEL_DETAILID AS DETAILID_SEND
			,COUNT(DISTINCT CASE WHEN HVU_DEVICEID <> 99 THEN HVU_EMAILID ELSE NULL END) AS CNT_SEND_TOTAL
			,COUNT(DISTINCT CASE WHEN HVU_DEVICEID = 2 THEN HVU_EMAILID ELSE NULL END) AS CNT_SEND_PC
			,COUNT(DISTINCT CASE WHEN HVU_DEVICEID = 1 THEN HVU_EMAILID ELSE NULL END) AS CNT_SEND_MO
			,COUNT(DISTINCT CASE WHEN OPENDT IS NOT NULL THEN HVU_EMAILID ELSE NULL END) AS CNT_OPEN
		FROM
			TEMP_MASSMAIL_PARAMETER
			INNER JOIN TAT_DB_HISTORY_VISIT_USER ON MASSMAIL_CAMPAIGNID = HVU_CAMPAIGNID
												AND MASSMAIL_SENDDT = DATE_TRUNC('DAY', HVU_SENDDT)
												AND MASSMAIL_CHANNELID = HVU_CHANNELID
												AND MASSMAIL_DETAILID = HVU_CHANNEL_DETAILID
			INNER JOIN MKT..TUCMAILMAGDELIVERY AS MMD ON MASSMAIL_CAMPAIGNID = MMD.MAILMAGCAMPAIGNID
			INNER JOIN MKT..TUCMAILMAGDELIVERYDETAIL AS MMDD ON MMD.ARTICLEID = MMDD.ARTICLEID
		WHERE
			HVU_SENDDT >= CAST('${pd_base_date}' AS TIMESTAMP) + INTERVAL '-8DAYS'
			AND HVU_SENDDT < CAST('${pd_base_date}' AS TIMESTAMP)
			AND DATE_TRUNC('DAY', DELIVERYDT) >= CAST('${pd_base_date}' AS TIMESTAMP) + INTERVAL '-8DAYS'
			AND DATE_TRUNC('DAY', DELIVERYDT) < CAST('${pd_base_date}' AS TIMESTAMP)
		GROUP BY
			CAMPAIGN_SEND
			,SENDDT_SEND
			,CHANNELID_SEND
			,DETAILID_SEND
	) AS SEND_TEMP ON MASSMAIL_CAMPAIGNID = CAMPAIGN_SEND AND MASSMAIL_SENDDT = SENDDT_SEND
	LEFT JOIN(
		------------------
		--流入数・経由売上
		------------------
		SELECT
			MASSMAIL_CAMPAIGNID AS CAMPAIGN_CLICK
			,DATE_TRUNC('DAY', HVU_SENDDT) AS SENDDT_CLICK
			,HVU_CHANNELID AS CHANNELID_CLICK
			,HVU_CHANNEL_DETAILID AS DETAILID_CLICK
			,COUNT(DISTINCT CASE WHEN HVU_DEVICEID <> 99 THEN HVU_FULLVISITORID ELSE NULL END) AS CNT_CLICK_TOTAL
			,COUNT(DISTINCT CASE WHEN HVU_DEVICEID = 2 THEN HVU_FULLVISITORID ELSE NULL END) AS CNT_CLICK_PC
			,COUNT(DISTINCT CASE WHEN HVU_DEVICEID = 1 THEN HVU_FULLVISITORID ELSE NULL END) AS CNT_CLICK_MO
			
			,SUM(DISTINCT CASE WHEN HVU_DEVICEID <> 99 THEN HVU_REVENUE ELSE NULL END) AS REVENUE_TOTAL
			,SUM(DISTINCT CASE WHEN HVU_DEVICEID = 2 THEN HVU_REVENUE ELSE 0 END) AS REVENUE_PC
			,SUM(DISTINCT CASE WHEN HVU_DEVICEID = 1 THEN HVU_REVENUE ELSE 0 END) AS REVENUE_MO
		FROM
			TEMP_MASSMAIL_PARAMETER
			INNER JOIN TAT_DB_HISTORY_VISIT_USER ON MASSMAIL_CAMPAIGNID = HVU_CAMPAIGNID
												AND MASSMAIL_SENDDT = DATE_TRUNC('DAY', HVU_SENDDT)
												AND MASSMAIL_CHANNELID = HVU_CHANNELID
												AND MASSMAIL_DETAILID = HVU_CHANNEL_DETAILID
		WHERE
			HVU_SENDDT >= CAST('${pd_base_date}' AS TIMESTAMP) + INTERVAL '-8DAYS'
			AND HVU_SENDDT < CAST('${pd_base_date}' AS TIMESTAMP)
		GROUP BY
			CAMPAIGN_CLICK
			,SENDDT_CLICK
			,CHANNELID_CLICK
			,DETAILID_CLICK
	) AS CLICK_TEMP ON MASSMAIL_CAMPAIGNID = CAMPAIGN_CLICK AND MASSMAIL_SENDDT = SENDDT_CLICK
