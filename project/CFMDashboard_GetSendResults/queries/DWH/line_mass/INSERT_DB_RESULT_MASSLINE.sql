BEGIN
;

-- 更新データを初期化
DELETE FROM TAT_DB_RESULT_MASSLINE
WHERE
    (
        (
            RML_SENDDT >= '${pd_base_date}'::DATE + INTERVAL '-8DAYS'
            OR
            RML_SENDDT < DATE_TRUNC('MONTH','${pd_base_date}'::DATE + INTERVAL '-25MONTHS')
        )
        AND RML_SENDDT IS NOT NULL
    )
    OR
    (
        (
            RML_VISITDT >= '${pd_base_date}'::DATE + INTERVAL '-8DAYS'
            OR
            RML_VISITDT < DATE_TRUNC('MONTH','${pd_base_date}'::DATE + INTERVAL '-25MONTHS')
        )
        AND RML_VISITDT IS NOT NULL
    )
;

--日ごとの流入通数、経由売上
INSERT INTO TAT_DB_RESULT_MASSLINE
SELECT
    HVU_CHANNEL_DETAILID AS RML_CHANNEL_DETAILID
    ,HVU_CAMPAIGNID AS RML_CAMPAIGNID
    ,HVU_SENDDT AS RML_SENDDT
    ,NULL AS RML_VISITDT
    ,COUNT(DISTINCT HVU_FULLVISITORID) AS RML_CNT_CLICK
    ,SUM(HVU_REVENUE) AS RML_REVENUE_TOTAL
FROM
    TAT_DB_HISTORY_VISIT_USER
WHERE
    HVU_SENDDT >= '${pd_base_date}'::DATE + INTERVAL '-8DAYS'
    AND HVU_SENDDT < '${pd_base_date}'::DATE
    AND HVU_CHANNELID = 2--LINE
    AND HVU_CHANNEL_DETAILID IN (2,5)--マス,タイムライン
    AND HVU_VISITTIME >= HVU_SENDDT::DATE
GROUP BY
    RML_CHANNEL_DETAILID
    ,RML_CAMPAIGNID
    ,RML_SENDDT
    ,RML_VISITDT

UNION ALL

SELECT
    HVU_CHANNEL_DETAILID AS RML_CHANNEL_DETAILID
    ,HVU_CAMPAIGNID AS RML_CAMPAIGNID
    ,NULL AS RML_SENDDT
    ,TO_CHAR(HVU_VISITTIME,'YYYY-MM-DD') AS RML_VISITDT
    ,COUNT(DISTINCT HVU_FULLVISITORID) AS RML_CNT_CLICK
    ,SUM(HVU_REVENUE) AS RML_REVENUE_TOTAL
FROM
    TAT_DB_HISTORY_VISIT_USER
WHERE
    HVU_VISITTIME >= '${pd_base_date}'::DATE + INTERVAL '-8DAYS'
    AND HVU_VISITTIME < '${pd_base_date}'::DATE
    AND HVU_CHANNELID = 2--LINE
    AND HVU_CHANNEL_DETAILID = 6--リッチメニュー
GROUP BY
    RML_CHANNEL_DETAILID
    ,RML_CAMPAIGNID
    ,RML_SENDDT
    ,RML_VISITDT
;

COMMIT
;